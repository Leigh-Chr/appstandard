<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Offline - AppStandard Calendar</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        text-align: center;
      }
      @media (prefers-color-scheme: dark) {
        body {
          background-color: #2a2218;
          color: #fbf9f6;
        }
        .card {
          background-color: rgba(251, 249, 246, 0.05);
          border-color: rgba(251, 249, 246, 0.1);
        }
        .pending-badge {
          background-color: rgba(234, 179, 8, 0.2);
          color: #fbbf24;
        }
      }
      @media (prefers-color-scheme: light) {
        body {
          background-color: #fbf9f6;
          color: #2a2218;
        }
        .card {
          background-color: rgba(42, 34, 24, 0.03);
          border-color: rgba(42, 34, 24, 0.1);
        }
        .pending-badge {
          background-color: rgba(234, 179, 8, 0.15);
          color: #b45309;
        }
      }
      .icon {
        width: 80px;
        height: 80px;
        margin-bottom: 1.5rem;
        opacity: 0.6;
      }
      h1 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }
      p {
        font-size: 1rem;
        opacity: 0.7;
        max-width: 320px;
        line-height: 1.5;
        margin-bottom: 1rem;
      }
      .card {
        padding: 1rem 1.5rem;
        border-radius: 0.75rem;
        border: 1px solid;
        margin-bottom: 1.5rem;
        max-width: 320px;
      }
      .pending-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
      }
      .pending-icon {
        width: 16px;
        height: 16px;
      }
      .status {
        font-size: 0.875rem;
        opacity: 0.6;
        margin-top: 0.75rem;
      }
      .status.checking {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }
      .spinner {
        width: 14px;
        height: 14px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      .buttons {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        justify-content: center;
      }
      button {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        font-weight: 500;
        border: none;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: opacity 0.2s, transform 0.1s;
      }
      button:active {
        transform: scale(0.98);
      }
      @media (prefers-color-scheme: dark) {
        button.primary {
          background-color: #fbf9f6;
          color: #2a2218;
        }
        button.secondary {
          background-color: transparent;
          color: #fbf9f6;
          border: 1px solid rgba(251, 249, 246, 0.2);
        }
      }
      @media (prefers-color-scheme: light) {
        button.primary {
          background-color: #2a2218;
          color: #fbf9f6;
        }
        button.secondary {
          background-color: transparent;
          color: #2a2218;
          border: 1px solid rgba(42, 34, 24, 0.2);
        }
      }
      button:hover {
        opacity: 0.9;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <!-- Offline WiFi icon -->
    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <line x1="1" y1="1" x2="23" y2="23"></line>
      <path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"></path>
      <path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"></path>
      <path d="M10.71 5.05A16 16 0 0 1 22.58 9"></path>
      <path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"></path>
      <path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path>
      <line x1="12" y1="20" x2="12.01" y2="20"></line>
    </svg>

    <h1>You're offline</h1>
    <p>Don't worry, your changes are saved locally and will sync when you're back online.</p>

    <!-- Pending operations card (shown if there are pending operations) -->
    <div class="card hidden" id="pending-card">
      <div class="pending-badge">
        <svg class="pending-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 2v4"></path>
          <path d="m16.2 7.8 2.9-2.9"></path>
          <path d="M18 12h4"></path>
          <path d="m16.2 16.2 2.9 2.9"></path>
          <path d="M12 18v4"></path>
          <path d="m4.9 19.1 2.9-2.9"></path>
          <path d="M2 12h4"></path>
          <path d="m4.9 4.9 2.9 2.9"></path>
        </svg>
        <span id="pending-count">0 changes pending</span>
      </div>
      <p class="status" id="status-text">Waiting for connection...</p>
    </div>

    <div class="buttons">
      <button class="primary" onclick="window.location.reload()">Try again</button>
      <button class="secondary" onclick="goBack()">Go back</button>
    </div>

    <script>
      // Check for pending operations in localStorage/IndexedDB
      function updatePendingCount() {
        try {
          // Try to get pending count from localStorage (set by the app)
          const pendingData = localStorage.getItem('appstandard-sync-queue');
          if (pendingData) {
            const queue = JSON.parse(pendingData);
            const count = Array.isArray(queue) ? queue.length : 0;
            if (count > 0) {
              document.getElementById('pending-card').classList.remove('hidden');
              document.getElementById('pending-count').textContent =
                count === 1 ? '1 change pending' : `${count} changes pending`;
            }
          }
        } catch (e) {
          // Silently fail - localStorage might not be available
        }
      }

      // Auto-retry when online
      let checkingConnection = false;
      function checkConnection() {
        if (checkingConnection) return;
        checkingConnection = true;

        const statusEl = document.getElementById('status-text');
        const cardEl = document.getElementById('pending-card');

        if (!cardEl.classList.contains('hidden')) {
          statusEl.innerHTML = `
            <span class="checking">
              <svg class="spinner" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
              </svg>
              Checking connection...
            </span>
          `;
        }

        // Try to fetch a small resource to verify connectivity
        fetch('/health?quick=true', { cache: 'no-store' })
          .then(response => {
            if (response.ok) {
              // We're back online!
              if (!cardEl.classList.contains('hidden')) {
                statusEl.textContent = 'Connection restored! Redirecting...';
              }
              setTimeout(() => {
                // Go back to the previous page or home
                if (document.referrer && document.referrer.includes(window.location.origin)) {
                  window.location.href = document.referrer;
                } else {
                  window.location.href = '/';
                }
              }, 500);
            } else {
              throw new Error('Still offline');
            }
          })
          .catch(() => {
            if (!cardEl.classList.contains('hidden')) {
              statusEl.textContent = 'Still offline. Will retry automatically...';
            }
            checkingConnection = false;
          });
      }

      // Listen for online event
      window.addEventListener('online', () => {
        checkConnection();
      });

      // Check connection periodically
      setInterval(() => {
        if (navigator.onLine) {
          checkConnection();
        }
      }, 5000);

      // Go back function
      function goBack() {
        if (window.history.length > 1) {
          window.history.back();
        } else {
          window.location.href = '/';
        }
      }

      // Initialize
      updatePendingCount();

      // Initial connection check after a short delay
      setTimeout(checkConnection, 1000);
    </script>
  </body>
</html>
